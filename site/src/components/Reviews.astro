---
import reviewsData from '../../content/reviews/index.json';

const { headline, subtext, reviews } = reviewsData;

const starPath = "M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z";
const chevronLeft = "M15 6l-6 6 6 6";
const chevronRight = "M9 6l6 6-6 6";
---

<section id="reviews" class="bg-light py-8 md:py-12 scroll-mt-20 scroll-animate">
  <div class="container max-w-[1100px] mx-auto px-4">
    <h2 class="font-accent text-primary italic text-3xl md:text-5xl text-center mb-3 font-medium">
      {headline}
    </h2>
    <p class="text-center text-gray-600 mb-8 md:mb-10 max-w-[600px] mx-auto text-sm md:text-base">
      {subtext}
    </p>

    <div class="reviews-shell">
      <button class="reviews-nav prev" aria-label="Recenzia anterioara">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d={chevronLeft} />
        </svg>
      </button>

      <div class="reviews-viewport">
        <div class="reviews-track">
          {reviews.map((r) => (
            <article class="review-card stagger-item">
              <div class="review-top">
                <div class="review-avatar review-avatar-img">
                  <img src={`${import.meta.env.BASE_URL}${r.img.replace(/^\//, '')}`} alt={r.name} />
                </div>
                <div class="review-meta">
                  <p class="review-name">{r.name}</p>
                  <div class="review-stars" aria-label="5 stele">
                    {Array(5).fill(null).map(() => (
                      <svg viewBox="0 0 20 20" aria-hidden="true">
                        <path d={starPath} />
                      </svg>
                    ))}
                  </div>
                </div>
              </div>
              <p class="review-quote">"{r.quote}"</p>
              <div class="review-divider"></div>
              <p class="review-role">{r.role}</p>
            </article>
          ))}
        </div>
      </div>

      <button class="reviews-nav next" aria-label="Recenzia urmatoare">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d={chevronRight} />
        </svg>
      </button>
    </div>
  </div>
</section>

<script>
  const track = document.querySelector('#reviews .reviews-track') as HTMLElement;
  const prevButton = document.querySelector('#reviews .reviews-nav.prev');
  const nextButton = document.querySelector('#reviews .reviews-nav.next');
  const viewport = document.querySelector('#reviews .reviews-viewport') as HTMLElement;

  if (track && prevButton && nextButton && viewport) {
    let isAnimating = false;
    const DURATION = 450;
    const EASING = 'cubic-bezier(0.4, 0, 0.2, 1)';

    const getShift = () => {
      const card = track.querySelector('.review-card') as HTMLElement;
      if (!card) return 0;
      const gap = parseFloat(getComputedStyle(track).gap) || 0;
      return card.offsetWidth + gap;
    };

    const onNext = () => {
      if (isAnimating) return;
      isAnimating = true;
      const shift = getShift();
      track.style.transition = `transform ${DURATION}ms ${EASING}`;
      track.style.transform = `translate3d(-${shift}px, 0, 0)`;
      let done = false;
      const finish = () => {
        if (done) return;
        done = true;
        track.style.transition = 'none';
        track.appendChild(track.firstElementChild!);
        track.style.transform = 'translate3d(0, 0, 0)';
        requestAnimationFrame(() => requestAnimationFrame(() => { isAnimating = false; }));
      };
      track.addEventListener('transitionend', finish, { once: true });
      setTimeout(finish, DURATION + 100);
    };

    const onPrev = () => {
      if (isAnimating) return;
      isAnimating = true;
      const shift = getShift();
      track.style.transition = 'none';
      track.insertBefore(track.lastElementChild!, track.firstElementChild);
      track.style.transform = `translate3d(-${shift}px, 0, 0)`;
      requestAnimationFrame(() => requestAnimationFrame(() => {
        track.style.transition = `transform ${DURATION}ms ${EASING}`;
        track.style.transform = 'translate3d(0, 0, 0)';
        let done = false;
        const finish = () => { if (done) return; done = true; isAnimating = false; };
        track.addEventListener('transitionend', finish, { once: true });
        setTimeout(finish, DURATION + 100);
      }));
    };

    prevButton.addEventListener('click', onPrev);
    nextButton.addEventListener('click', onNext);

    let touchStartX = 0;
    let touchStartY = 0;
    viewport.addEventListener('touchstart', (e) => {
      touchStartX = (e as TouchEvent).changedTouches[0].clientX;
      touchStartY = (e as TouchEvent).changedTouches[0].clientY;
    }, { passive: true });
    viewport.addEventListener('touchend', (e) => {
      const dx = (e as TouchEvent).changedTouches[0].clientX - touchStartX;
      const dy = Math.abs((e as TouchEvent).changedTouches[0].clientY - touchStartY);
      if (Math.abs(dx) > 50 && dy < 100) dx > 0 ? onPrev() : onNext();
    });
  }
</script>